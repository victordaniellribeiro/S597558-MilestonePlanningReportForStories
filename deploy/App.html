<!DOCTYPE html>
<html>
<head>
    <title>S597558-MilestonePlanningReportForStories</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_initDate:void 0,_endDate:void 0,_selectedMilestones:void 0,_filterPlannedStartDate:void 0,_filterPlannedEndDate:void 0,_filterInitiative:void 0,_filterParent:void 0,_filterProject:void 0,_exportData:void 0,_exportButton:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",layout:{type:"hbox"},height:"90%",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;this.projectId=e,this._milestoneComboStore=void 0,console.log("project:",e),this._milestoneCombo=Ext.widget("rallymilestonecombobox",{itemId:"milestonecombobox",allowClear:!0,multiSelect:!0,width:300,listeners:{change:function(e){if(console.log("change: ",e.getValue()),e.getValue()&&""!=e.getValue()&&e.valueModels.length>0){var t=e.valueModels;t.sort(function(e,t){return e.get("TargetDate").getTime()-t.get("TargetDate").getTime()}),this._selectedMilestones=t,this._doSearch(t)}else this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},beforerender:function(e){console.log("beforerender: ",e),this._blockFilters()},ready:function(e){console.log("ready: ",e.value),this._unBlockFilters()},scope:this}}),this._milestoneComboStore=this._milestoneCombo.getStore(),this.down("#header").add([{xtype:"panel",autoWidth:!0,layout:"hbox",items:[{xtype:"panel",title:"Choose date range for milestone:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"datefield",anchor:"100%",fieldLabel:"From",scope:this,listeners:{change:function(e,t,i){this._initDate=t;this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},scope:this}},{xtype:"datefield",anchor:"100%",fieldLabel:"To",scope:this,listeners:{change:function(e,t,i){this._endDate=t;this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},scope:this}},{xtype:"rallycheckboxfield",fieldLabel:"Extra Filters:",itemId:"extraFilters",listeners:{change:function(e,t,i){console.log("value check:",t),t?this._showExtraFilters():this._hideExtraFilters()},scope:this}},{xtype:"panel",itemId:"extraFiltersPanel",layout:"hbox",hidden:!0,align:"stretch",bodyPadding:10,items:[{xtype:"datefield",fieldLabel:"Planned Start Date",margin:"0 15 0 0",scope:this,listeners:{change:function(e,t,i){this._filterPlannedStartDate=t},scope:this}},{xtype:"datefield",fieldLabel:"Planned End Date",margin:"0 15 0 0",scope:this,listeners:{change:function(e,t,i){this._filterPlannedEndDate=t},scope:this}},{xtype:"rallytextfield",fieldLabel:"Parent",margin:"0 15 0 0",scope:this,listeners:{change:function(e,t,i){this._filterParent=t,console.log("filter parent:",this._filterParent)},scope:this}},{xtype:"rallytextfield",fieldLabel:"Initiative ID",margin:"0 15 0 0",scope:this,listeners:{change:function(e,t,i){this._filterInitiative=t,console.log("filter Initiative:",this._filterInitiative)},scope:this}},{xtype:"rallytextfield",fieldLabel:"Project",margin:"0 15 0 0",scope:this,listeners:{change:function(e,t,i){this._filterProject=t,console.log("filter project:",this._filterProject)},scope:this}},{xtype:"rallybutton",text:"Apply Filter",margin:"0 15 0 0",scope:this,handler:function(){console.log("Apply filter"),this._doSearch(this._selectedMilestones)}}]}]}]},{xtype:"fieldcontainer",fieldLabel:"Milestone",pack:"end",labelAlign:"right",items:[this._milestoneCombo]}])},_createExportButton:function(e){return Ext.create("Rally.ui.Button",{text:"Export",margin:"10 10 10 10",scope:this,handler:function(){var t=this._convertToCSV(e);console.log("converting to csv:",t);var i=document.createElement("a"),o=new Blob(["\ufeff",t]),a=URL.createObjectURL(o);i.href=a,i.download="report.csv",document.body.appendChild(i),i.click(),document.body.removeChild(i)}})},_blockFilters:function(){this.down("#header").disable()},_unBlockFilters:function(){this.down("#header").enable()},_hideExtraFilters:function(){this.down("#extraFiltersPanel").hide()},_showExtraFilters:function(){this.down("#extraFiltersPanel").show()},_doSearch:function(e){this.setLoading(),this.down("#bodyContainer").removeAll(!0),this._exportData=new Ext.util.MixedCollection;var t=[];for(var i of e)t.push(this._buildMilestoneColumn(i));Deft.Promise.all(t).then({success:function(e){this.setLoading(!1);var t=this._convertExportDataToJson(this._exportData);this._exportButton?(this.down("#header").remove(this._exportButton),this._exportButton=this._createExportButton(t),this.down("#header").add(this._exportButton)):(this._exportButton=this._createExportButton(t),this.down("#header").add(this._exportButton))},scope:this})},_applyMilestoneRangeFilter:function(e,t,i,o){e&&!t?this._milestoneComboStore.filterBy(function(t){if(t.get("TargetDate")&&t.get("TargetDate").getTime()>e.getTime())return t},o):t&&!e?this._milestoneComboStore.filterBy(function(e){if(e.get("TargetDate")&&e.get("TargetDate").getTime()<t.getTime())return e},o):e&&t?this._milestoneComboStore.filterBy(function(i){if(i.get("TargetDate")&&i.get("TargetDate").getTime()>e.getTime()&&i.get("TargetDate").getTime()<t.getTime())return i},o):this._milestoneComboStore.filterBy(function(e){return e})},_buildMilestoneColumn:function(e){var t=Ext.create("Deft.Deferred"),i=e.get("TargetDate"),o=e.get("ObjectID"),a=e.get("_ref"),n=e.get("Name"),r="milestone-"+o,l=i.toLocaleDateString(),s=Ext.create("Ext.panel.Panel",{title:"Target Date: "+l,width:320,layout:{type:"vbox",padding:5},padding:5,itemId:r}),c={property:"Milestones",operator:"contains",value:a};return this.down("#extraFilters").value&&(console.log("using extraFilters"),this._filterPlannedStartDate&&(c=Rally.data.QueryFilter.and([c,{property:"PlannedStartDate",operator:">=",value:this._filterPlannedStartDate}])),this._filterPlannedEndDate&&(c=Rally.data.QueryFilter.and([c,{property:"PlannedEndDate",operator:"<=",value:this._filterPlannedEndDate}])),this._filterProject&&(c=Rally.data.QueryFilter.and([c,{property:"Project.Name",value:this._filterProject}])),this._filterParent&&(c=Rally.data.QueryFilter.and([c,{property:"Parent.Name",value:this._filterParent}])),this._filterInitiative&&(c=Rally.data.QueryFilter.and([c,{property:"Parent.FormattedID",value:this._filterInitiative}]))),console.log("filter:",c),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["PortfolioItem/Feature","HierarchicalRequirement","Defect","TestSet"],fetch:["FormattedID","Name","Owner","ObjectID","Project","Parent","State","Type","PlanEstimate","PreliminaryEstimateValue","LeafStoryPlanEstimateTotal","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate"],filters:[c],limit:1/0}).load().then({success:function(e){if(e){var i=this._buildSummaryCard(n,e);s.add(i);var a={milestoneName:n,milestoneId:o,featuresArray:[]},r=[];_.each(e,function(e){"portfolioitem/feature"==e.get("_type")&&r.push(e.get("ObjectID"))},this),Ext.create("Rally.data.WsapiDataStore",{model:"HierarchicalRequirement",context:{projectScopeUp:!1,projectScopeDown:!0,project:null},fetch:["FormattedID","Name","ObjectID","Project","ScheduleState","Type","PlanEstimate","Blocked"],filters:[{property:"PortfolioItem.ObjectID",operator:"in",value:r}],limit:1/0}).load().then({success:function(i){console.log("Stories:",i);var n=e.concat(i);console.log("artifacts",n),_.each(n,function(e){var t;s.add(this._buildKanbanCard(e)),t="portfolioitem/feature"==e.get("_type")?e.get("LeafStoryPlanEstimateTotal"):e.get("PlanEstimate");var i={id:e.get("FormattedID"),description:e.get("Name"),planEstimate:t};a.featuresArray.push(i)},this),this._exportData.add(o,a),t.resolve()},scope:this})}},scope:this}),this.down("#bodyContainer").add(s),t.promise},_buildSummaryCard:function(e,t){var i=0,o=0,a=0;return _.each(t,function(e){"portfolioitem/feature"==e.get("_type")?(i+=e.get("PreliminaryEstimateValue"),o+=e.get("LeafStoryPlanEstimateTotal")):a+=e.get("PlanEstimate")}),Ext.widget("propertygrid",{title:e+" summary:",hideHeaders:!0,nameColumnWidth:200,padding:"0 0 20 15",width:280,source:{"Total Feature Pts":i,"Total Leaf Story Pts":o,"Total Defect PTs":a}})},_buildKanbanCard:function(e){return Ext.widget("rallycard",{itemId:e.get("FormattedID"),config:{record:e},fields:["Name","Owner","FormattedID","Tags","Project","Parent","PlanEstimate","LeafStoryPlanEstimateTotal","PercentDoneByStoryPlanEstimate"],width:280,record:e})},_convertToCSV:function(e){var t=Object.keys(e[0]),i=function(e,t){return null===t?"":t},o=e.map(function(e){return t.map(function(t){return JSON.stringify(e[t],i)}).join(",")});return o.unshift(t.join(",")),o.join("\r\n")},_convertExportDataToJson:function(e){var t=[];return e.eachKey(function(e,i){var o=i.milestoneName;_.each(i.featuresArray,function(e){t.push({milestoneName:o,featureNumber:e.id,featureDescription:e.description,planEstimate:e.planEstimate})},this)},this),t}});

            Rally.launchApp('CustomApp', {
                name:"S597558-MilestonePlanningReportForStories",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
